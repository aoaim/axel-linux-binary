name: Build and Publish Binaries

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"

permissions:
  contents: write

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.tag.outputs.release_tag }}
      axel_tag: ${{ steps.tags.outputs.axel_tag }}
      wget2_tag: ${{ steps.tags.outputs.wget2_tag }}
      should_run: ${{ steps.decide.outputs.should_run }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - id: tag
        name: Set release tag
        run: echo "release_tag=$(date -u +%Y%m%d)" >> $GITHUB_OUTPUT

      - id: tags
        name: Resolve latest upstream tags
        run: |
          axel_tag=$(git ls-remote --tags --sort="v:refname" https://github.com/axel-download-accelerator/axel.git | tail -n 1 | sed 's@.*/@@;s@\^{}@@')
          wget2_tag=$(git ls-remote --tags --sort="v:refname" https://gitlab.com/gnuwget/wget2.git | tail -n 1 | sed 's@.*/@@;s@\^{}@@')
          echo "axel_tag=$axel_tag" >> $GITHUB_OUTPUT
          echo "wget2_tag=$wget2_tag" >> $GITHUB_OUTPUT

      - id: decide
        name: Decide whether to build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AXEL_TAG: ${{ steps.tags.outputs.axel_tag }}
          WGET2_TAG: ${{ steps.tags.outputs.wget2_tag }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          latest_body=$(gh release view --json body -q .body 2>/dev/null || true)
          latest_axel=$(printf "%s" "$latest_body" | sed -n 's/^axel_tag=//p')
          latest_wget2=$(printf "%s" "$latest_body" | sed -n 's/^wget2_tag=//p')
          if [ "$latest_axel" != "$AXEL_TAG" ] || [ "$latest_wget2" != "$WGET2_TAG" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Ensure release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ steps.tag.outputs.release_tag }}
          AXEL_TAG: ${{ steps.tags.outputs.axel_tag }}
          WGET2_TAG: ${{ steps.tags.outputs.wget2_tag }}
        if: steps.decide.outputs.should_run == 'true'
        run: |
          notes=$(printf "axel_tag=%s\nwget2_tag=%s\n" "$AXEL_TAG" "$WGET2_TAG")
          gh release view "$RELEASE_TAG" >/dev/null 2>&1 || \
          gh release create "$RELEASE_TAG" --title "$RELEASE_TAG" --notes "$notes" --target "${{ github.sha }}"

  build:
    name: Build ${{ matrix.package }} ${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should_run == 'true'
    env:
      RELEASE_TAG: ${{ needs.prepare.outputs.release_tag }}
      AXEL_TAG: ${{ needs.prepare.outputs.axel_tag }}
      WGET2_TAG: ${{ needs.prepare.outputs.wget2_tag }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - package: axel
            arch: amd64
            platform: linux/amd64
          - package: axel
            arch: arm64
            platform: linux/arm64
          - package: wget2
            arch: amd64
            platform: linux/amd64
          - package: wget2
            arch: arm64
            platform: linux/arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Make scripts executable
        run: chmod +x builder.sh builder-wget2.sh

      - name: Build in Docker
        run: |
          mkdir -p output
          docker run --rm --platform ${{ matrix.platform }} \
            -v ${{ github.workspace }}:/workspace \
            -v ${{ github.workspace }}/output:/output \
            rockylinux:8 \
            /bin/bash -c "if [ '${{ matrix.package }}' = 'axel' ]; then /workspace/builder.sh '$AXEL_TAG' '${{ matrix.arch }}'; else /workspace/builder-wget2.sh '$WGET2_TAG' '${{ matrix.arch }}'; fi"

      - name: Upload Release Asset
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "$RELEASE_TAG" "output/${{ matrix.package }}-${{ matrix.arch }}" --clobber
